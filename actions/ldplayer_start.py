import os
import time
import pyautogui
from config import TEMPLATES_PATH

def wait_and_click(image_name, timeout=15, confidence=0.7):
    """
    –§—É–Ω–∫—Ü–∏—è –∂–¥—ë—Ç –ø–æ—è–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ –∏ –∫–ª–∏–∫–∞–µ—Ç –ø–æ –Ω–µ–º—É.
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
    image_name - –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "ok_button.png")
    timeout - —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –∂–¥–∞—Ç—å –ø–æ—è–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    confidence - —Ç–æ—á–Ω–æ—Å—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (–æ—Ç 0 –¥–æ 1, –≥–¥–µ 1 - —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
    """
    print(f"üîç –ò—â–µ–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ: {image_name}")
    
    # –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø–æ–∏—Å–∫–∞
    start_time = time.time()
    
    # –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    image_path = os.path.join(TEMPLATES_PATH, image_name)
    
    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–∏—Å–∫, –ø–æ–∫–∞ –Ω–µ –∏—Å—Ç–µ—á—ë—Ç –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è
    while time.time() - start_time < timeout:
        try:
            # –ò—â–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
            # locateCenterOnScreen –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            image_location = pyautogui.locateCenterOnScreen(image_path, confidence=confidence)
            
            # –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ
            if image_location:
                # –ö–ª–∏–∫–∞–µ–º –ø–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                pyautogui.click(image_location)
                print(f"‚úÖ –ù–∞—à–ª–∏ –∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ: {image_name}")
                return True
                
        except Exception as error:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {error}")
            
        # –ñ–¥—ë–º –ø–æ–ª—Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
        time.sleep(0.5)
    
    # –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞ –æ—Ç–≤–µ–¥—ë–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏: {image_name}")
    return False

def start_ldplayer(ldplayer_path=r"C:\LDPlayer\LDPlayer9\dnplayer.exe", wait_time=15):
    """
    –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç LDPlayer –∏ –∂–¥—ë—Ç –µ–≥–æ –∑–∞–≥—Ä—É–∑–∫–∏.
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
    ldplayer_path - –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É LDPlayer
    wait_time - —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –∂–¥–∞—Ç—å –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    True - –µ—Å–ª–∏ LDPlayer —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω
    False - –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
    """
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª LDPlayer
        if not os.path.exists(ldplayer_path):
            print(f"‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª {ldplayer_path} –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return False
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º LDPlayer
        print(f"üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º LDPlayer: {ldplayer_path}")
        os.startfile(ldplayer_path)
        
        # –ñ–¥—ë–º, –ø–æ–∫–∞ LDPlayer –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
        print(f"‚è≥ –ñ–¥—ë–º {wait_time} —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏...")
        time.sleep(wait_time)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—è–≤–∏–ª–æ—Å—å –ª–∏ –æ–∫–Ω–æ —Å –∫–Ω–æ–ø–∫–æ–π "–Ø—Å–Ω–æ"
        print("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ–∫–Ω–æ —Å –∫–Ω–æ–ø–∫–æ–π '–Ø—Å–Ω–æ'...")
        try:
            # –ò—â–µ–º –∫–Ω–æ–ø–∫—É "–Ø—Å–Ω–æ" –≤ —Ç–µ—á–µ–Ω–∏–µ 20 —Å–µ–∫—É–Ω–¥
            if wait_and_click("ok_button.png", timeout=20):
                print("‚úÖ –ù–∞—à–ª–∏ –∏ –Ω–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–∫—É '–Ø—Å–Ω–æ'")
                # –ñ–¥—ë–º 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è
                time.sleep(2)
        except:
            # –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ –ø–æ—è–≤–∏–ª–∞—Å—å - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É
            print("‚ÑπÔ∏è –û–∫–Ω–æ —Å –∫–Ω–æ–ø–∫–æ–π '–Ø—Å–Ω–æ' –Ω–µ –ø–æ—è–≤–∏–ª–æ—Å—å, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...")
        
        print("‚úÖ LDPlayer —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω")
        return True
        
    except Exception as error:
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ LDPlayer: {error}")
        return False
